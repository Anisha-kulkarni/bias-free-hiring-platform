<%- include('partials/header') %>

    <div class="container" style="padding-top: 3rem; max-width: 900px; animation: fadeIn 0.5s ease-out;">
        <div style="margin-bottom: 2rem;">
            <a href="/dashboard"
                style="display: inline-flex; align-items: center; gap: 0.5rem; color: var(--color-text-muted); transition: color 0.2s;">
                &larr; Back to Path
            </a>
        </div>

        <div class="unit-content" style="
            background: var(--color-bg-card); 
            padding: 3rem; 
            border-radius: var(--radius-lg); 
            border: 1px solid rgba(255,255,255,0.05);
            animation: fadeInUp 0.5s ease-out 0.2s backwards;
        ">
            <header style="margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <div
                    style="display: flex; gap: 1rem; align-items: center; justify-content: space-between; margin-bottom: 1rem; flex-wrap: wrap;">

                    <!-- Meta Tags -->
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span
                            style="font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: var(--color-accent);">
                            <%= unit.type %>
                        </span>
                        <span style="color: var(--color-text-muted);">‚Ä¢</span>
                        <span style="font-size: 0.8rem; color: var(--color-text-muted);">Lvl <%= unit.difficulty %>
                        </span>
                    </div>

                    <!-- Feature: Focus Mode & Difficulty Controls -->
                    <div style="display: flex; gap: 1rem; align-items: center;">

                        <!-- Difficulty Slider Widget -->
                        <div class="card"
                            style="padding: 0.4rem 0.8rem; display: flex; align-items: center; gap: 0.8rem; border-radius: 20px; background: rgba(0,0,0,0.3);">
                            <span style="font-size: 0.8rem; color: var(--color-text-muted);">Difficulty:</span>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <button onclick="adjustDifficulty(-1)"
                                    style="background:none; border:none; color:white; cursor:pointer;">-</button>
                                <div style="display: flex; gap: 2px;">
                                    <div id="diff-bar-1"
                                        style="width: 6px; height: 12px; background: var(--color-accent); border-radius: 2px;">
                                    </div>
                                    <div id="diff-bar-2"
                                        style="width: 6px; height: 12px; background: var(--color-accent); border-radius: 2px;">
                                    </div>
                                    <div id="diff-bar-3"
                                        style="width: 6px; height: 12px; background: rgba(255,255,255,0.2); border-radius: 2px;">
                                    </div>
                                </div>
                                <button onclick="adjustDifficulty(1)"
                                    style="background:none; border:none; color:white; cursor:pointer;">+</button>
                            </div>
                        </div>

                        <!-- Focus Mode Toggle -->
                        <button onclick="toggleFocusMode()" class="btn"
                            style="padding: 0.4rem 1rem; font-size: 0.8rem; background: transparent; border: 1px solid rgba(255,255,255,0.2);">
                            üëÅÔ∏è Focus Mode
                        </button>
                    </div>
                </div>

                <h1 style="font-size: 2.5rem; margin-top: 1rem;">
                    <%= unit.title %>
                </h1>
            </header>

            <!-- Video Section -->
            <!-- Responsive Video Section -->
            <% if (unit.youtube_url) { %>
                <style>
                    .video-container {
                        position: relative;
                        width: 100%;
                        height: 0;
                        padding-bottom: 56.25%;
                        /* 16:9 Aspect Ratio */
                        border-radius: var(--radius-md);
                        overflow: hidden;
                        border: 1px solid rgba(255, 255, 255, 0.1);
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                        margin-bottom: 2rem;
                    }

                    .video-container iframe {
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                    }
                </style>
                <div class="video-container">
                    <iframe src="<%= unit.youtube_url %>" title="YouTube video player" frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                        allowfullscreen>
                    </iframe>
                </div>

                <!-- "Watch on YouTube" Redirect Button -->
                <div style="text-align: center; margin-bottom: 2rem;">
                    <% /* Convert Embed URL to Watch URL for the button */ let watchUrl=unit.youtube_url; if(watchUrl &&
                        watchUrl.includes('/embed/')) { watchUrl=watchUrl.replace('/embed/', '/watch?v=' ); } %>
                        <a href="<%= watchUrl %>" target="_blank" class="btn"
                            style="background: #ff0000; border: none; display: inline-flex; align-items: center; gap: 0.5rem; text-decoration: none; color: white;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="white"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z" />
                            </svg>
                            Watch on YouTube
                        </a>
                </div>
                <% } else { %>
                    <!-- Fallback if no specific video is linked -->
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <a href="https://www.youtube.com/results?search_query=<%= unit.title %>" target="_blank"
                            class="btn"
                            style="background: #ff0000; border: none; display: inline-flex; align-items: center; gap: 0.5rem; text-decoration: none; color: white;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="white"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z" />
                            </svg>
                            Find Lesson on YouTube
                        </a>
                    </div>
                    <% } %>

                        <div class="content-body" style="font-size: 1.125rem; line-height: 1.8;">
                            <%- unit.content %>
                        </div>

                        <!-- Stylish Quiz Implementation -->
                        <style>
                            :root {
                                --color-primary-quiz: #4f46e5;
                                --color-secondary-quiz: #7c3aed;
                                --color-accent-quiz: #06b6d4;
                                --color-success-quiz: #10b981;
                                --color-error-quiz: #ef4444;
                                --bg-card-quiz: rgba(30, 41, 59, 0.6);
                            }

                            .quiz-wrapper {
                                margin-top: 4rem;
                                max-width: 100%;
                            }

                            .quiz-header-card {
                                text-align: center;
                                margin-bottom: 30px;
                                padding: 30px;
                                background: linear-gradient(135deg, rgba(79, 70, 229, 0.1), rgba(124, 58, 237, 0.1));
                                border: 1px solid rgba(255, 255, 255, 0.1);
                                border-radius: 16px;
                                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
                                backdrop-filter: blur(10px);
                            }

                            .quiz-title {
                                font-size: 2rem;
                                margin-bottom: 10px;
                                background: linear-gradient(to right, #fff, #c7d2fe);
                                -webkit-background-clip: text;
                                background-clip: text;
                                color: transparent;
                                font-weight: 700;
                            }

                            /* Difficulty Controls */
                            .difficulty-controls {
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                gap: 20px;
                                margin: 30px 0;
                                padding: 15px;
                                background: rgba(255, 255, 255, 0.03);
                                border-radius: 12px;
                                border: 1px solid rgba(255, 255, 255, 0.05);
                                width: fit-content;
                                margin-left: auto;
                                margin-right: auto;
                            }

                            .diff-bar {
                                width: 40px;
                                height: 6px;
                                background: rgba(255, 255, 255, 0.1);
                                border-radius: 4px;
                                transition: all 0.3s ease;
                            }

                            .diff-btn {
                                background: var(--color-primary-quiz);
                                color: white;
                                border: none;
                                width: 32px;
                                height: 32px;
                                border-radius: 50%;
                                font-size: 1.2rem;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                transition: all 0.2s ease;
                            }

                            .diff-btn:hover {
                                transform: scale(1.1);
                            }

                            /* Generate Button */
                            .generate-btn {
                                background: linear-gradient(135deg, var(--color-primary-quiz), var(--color-secondary-quiz));
                                color: white;
                                border: none;
                                padding: 16px 40px;
                                font-size: 1.1rem;
                                font-weight: 600;
                                border-radius: 50px;
                                cursor: pointer;
                                display: block;
                                margin: 0 auto;
                                transition: all 0.3s ease;
                                box-shadow: 0 6px 20px rgba(79, 70, 229, 0.3);
                                text-decoration: none;
                            }

                            .generate-btn:hover {
                                transform: translateY(-2px);
                                box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4);
                            }

                            .generate-btn:disabled {
                                opacity: 0.5;
                                cursor: not-allowed;
                                transform: none;
                            }

                            /* Question Cards */
                            .questions-container {
                                display: none;
                                margin-top: 30px;
                            }

                            .question-card {
                                background: var(--bg-card-quiz);
                                border: 1px solid rgba(255, 255, 255, 0.05);
                                border-left: 4px solid var(--color-primary-quiz);
                                padding: 25px;
                                margin-bottom: 20px;
                                border-radius: 12px;
                                transition: transform 0.2s ease;
                            }

                            .question-text {
                                font-size: 1.15rem;
                                margin-bottom: 20px;
                                font-weight: 500;
                                line-height: 1.5;
                            }

                            .option-btn {
                                background: rgba(255, 255, 255, 0.03);
                                border: 1px solid rgba(255, 255, 255, 0.1);
                                color: #f8fafc;
                                padding: 16px 20px;
                                border-radius: 10px;
                                text-align: left;
                                cursor: pointer;
                                transition: all 0.2s ease;
                                font-size: 1rem;
                                display: flex;
                                align-items: center;
                                gap: 12px;
                                width: 100%;
                                margin-bottom: 10px;
                            }

                            .option-btn:hover {
                                background: rgba(255, 255, 255, 0.08);
                                border-color: var(--color-primary-quiz);
                            }

                            .option-btn.selected {
                                background: rgba(79, 70, 229, 0.2);
                                border-color: var(--color-primary-quiz);
                            }

                            .option-letter {
                                background: rgba(255, 255, 255, 0.1);
                                width: 28px;
                                height: 28px;
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 0.9rem;
                                font-weight: 600;
                            }

                            .option-btn.selected .option-letter {
                                background: var(--color-primary-quiz);
                            }

                            /* Stats Grid */
                            .stats-grid {
                                display: grid;
                                grid-template-columns: repeat(3, 1fr);
                                gap: 20px;
                                margin: 30px 0;
                            }

                            .stat-card {
                                background: rgba(255, 255, 255, 0.03);
                                padding: 15px;
                                border-radius: 12px;
                                text-align: center;
                                border: 1px solid rgba(255, 255, 255, 0.05);
                            }

                            .stat-value {
                                font-size: 1.8rem;
                                font-weight: 700;
                                margin-bottom: 5px;
                                color: white;
                            }

                            .stat-label {
                                color: #94a3b8;
                                font-size: 0.85rem;
                                text-transform: uppercase;
                                letter-spacing: 1px;
                            }

                            .spinner {
                                width: 40px;
                                height: 40px;
                                border: 3px solid rgba(255, 255, 255, 0.1);
                                border-top: 3px solid var(--color-accent-quiz);
                                border-radius: 50%;
                                animation: spin 1s linear infinite;
                                margin: 0 auto 20px;
                            }

                            @keyframes spin {
                                0% {
                                    transform: rotate(0deg);
                                }

                                100% {
                                    transform: rotate(360deg);
                                }
                            }
                        </style>
                        <div class="quiz-wrapper">
                            <div class="quiz-header-card">
                                <h1 class="quiz-title">‚ú® AI Quiz Master</h1>
                                <p style="color: #94a3b8;">Test your mastery of <strong>
                                        <%= unit.title %>
                                    </strong></p>

                                <div class="difficulty-controls">
                                    <span
                                        style="color: #94a3b8; font-weight: 600; margin-right: 10px;">Difficulty:</span>
                                    <button class="diff-btn" onclick="adjustDifficulty(-1)">-</button>
                                    <div style="display: flex; gap: 6px; margin: 0 15px;">
                                        <div class="diff-bar" id="diff-bar-1"
                                            style="background: var(--color-accent-quiz)"></div>
                                        <div class="diff-bar" id="diff-bar-2"></div>
                                        <div class="diff-bar" id="diff-bar-3"></div>
                                    </div>
                                    <button class="diff-btn" onclick="adjustDifficulty(1)">+</button>
                                    <span id="diff-text"
                                        style="color: var(--color-accent-quiz); font-weight: 600; margin-left: 10px; width: 60px; text-align: center;">Medium</span>
                                </div>

                                <button id="generateBtn" class="generate-btn">
                                    üéÆ Generate New Quiz
                                </button>
                            </div>

                            <div id="questionsContainer" class="questions-container">
                                <!-- Questions Loaded Here -->
                            </div>

                            <div id="quizResults"
                                style="display: none; background: rgba(30,30,30,0.4); padding: 30px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); text-align: center; margin-top: 30px;">
                                <h2 style="font-size: 2rem; margin-bottom: 10px;">üéØ Quiz Results</h2>
                                <div id="scoreDisplay"
                                    style="font-size: 3.5rem; font-weight: 800; background: linear-gradient(135deg, var(--color-accent-quiz), var(--color-success-quiz)); -webkit-background-clip: text; background-clip: text; color: transparent;">
                                    0%</div>

                                <div class="stats-grid">
                                    <div class="stat-card">
                                        <div class="stat-value" id="correctCount">0</div>
                                        <div class="stat-label">Correct</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value" id="timeDisplay">0s</div>
                                        <div class="stat-label">Time</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value" id="totalQuestions">0</div>
                                        <div class="stat-label">Total</div>
                                    </div>
                                </div>

                                <div style="max-width: 250px; margin: 0 auto 30px; height: 250px;">
                                    <canvas id="performanceChart"></canvas>
                                </div>

                                <div id="quizFeedback"
                                    style="padding: 15px; border-radius: 10px; background: rgba(255,255,255,0.05); margin-bottom: 20px; font-size: 1.1rem;">
                                </div>

                                <button onclick="document.getElementById('generateBtn').click()" class="generate-btn">
                                    üîÑ Take Another Quiz
                                </button>
                            </div>
                        </div>

                        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                        <script>
                            let quizChart = null;
                            let quizStartTime = null;
                            let currentDifficulty = <%= unit.difficulty || 2 %>;
                            let currentQuizData = [];

                            // Initialize UI
                            updateDifficultyUI();

                            document.getElementById('generateBtn').addEventListener('click', async () => {
                                const container = document.getElementById('questionsContainer');
                                const btn = document.getElementById('generateBtn');
                                const resultsArea = document.getElementById('quizResults');

                                // Scroll
                                container.classList.remove('hidden');
                                container.style.display = 'block';
                                resultsArea.style.display = 'none';
                                container.scrollIntoView({ behavior: 'smooth', block: 'center' });

                                container.innerHTML = `
                <div class="loading" style="text-align: center; padding: 40px;">
                    <div class="spinner"></div>
                    <p style="color: #94a3b8;">üîÆ Generating Level ${currentDifficulty} Questions...</p>
                </div>
            `;

                                btn.disabled = true;
                                btn.style.opacity = '0.7';

                                try {
                                    // Call AI API
                                    const res = await fetch('/api/generate-questions', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            topic: '<%= unit.title %>',
                                            difficulty: currentDifficulty
                                        })
                                    });
                                    const data = await res.json();

                                    // Process Data
                                    if (data.questions) {
                                        currentQuizData = data.questions.map((q, index) => ({
                                            ...q,
                                            options: Array.isArray(q.options) ? q.options : JSON.parse(q.options || "[]"),
                                            questionNumber: index + 1,
                                            status: 'unanswered',
                                            userSelection: null
                                        }));
                                        startQuiz();
                                    } else {
                                        throw new Error('No questions returned');
                                    }

                                } catch (e) {
                                    console.error(e);
                                    container.innerHTML = `<div style="text-align: center; padding: 30px; color: #ef4444;">‚ùå Failed to generate questions. Please try again.</div>`;
                                } finally {
                                    btn.disabled = false;
                                    btn.style.opacity = '1';
                                }
                            });

                            function adjustDifficulty(change) {
                                let newDiff = currentDifficulty + change;
                                if (newDiff < 1) newDiff = 1;
                                if (newDiff > 3) newDiff = 3;
                                currentDifficulty = newDiff;
                                updateDifficultyUI();
                            }

                            function updateDifficultyUI() {
                                const labels = ['Easy', 'Medium', 'Hard'];
                                const colors = ['#10b981', '#06b6d4', '#ef4444'];

                                const diffText = document.getElementById('diff-text');
                                if (diffText) {
                                    diffText.innerText = labels[currentDifficulty - 1];
                                    diffText.style.color = colors[currentDifficulty - 1];
                                }

                                for (let i = 1; i <= 3; i++) {
                                    const bar = document.getElementById(`diff-bar-${i}`);
                                    if (bar) {
                                        bar.style.background = (i <= currentDifficulty) ? colors[currentDifficulty - 1] : 'rgba(255,255,255,0.1)';
                                    }
                                }
                            }

                            function startQuiz() {
                                quizStartTime = new Date();
                                renderQuiz();
                            }

                            function renderQuiz() {
                                const container = document.getElementById('questionsContainer');
                                let html = '';

                                currentQuizData.forEach((q, index) => {
                                    const questionText = q.question || q.Question || "Question";
                                    html += `
                    <div class="question-card" id="q-card-${index}">
                        <div class="question-text">
                            <span style="background: var(--color-primary-quiz); color: white; padding: 4px 12px; border-radius: 20px; margin-right: 10px; font-size: 0.85rem; vertical-align: middle;">
                                Q${index + 1}
                            </span>
                            ${questionText}
                        </div>
                        
                        <div class="options-container">
                            ${q.options.map((opt, optIndex) => `
                                <button class="option-btn" 
                                        onclick="selectOption(${index}, ${optIndex}, '${opt.replace(/'/g, "\\'")}')">
                                    <div class="option-letter">${String.fromCharCode(65 + optIndex)}</div>
                                    ${opt}
                                </button>
                            `).join('')}
                        </div>
                        
                        <div id="feedback-${index}" style="display: none; margin-top: 15px; padding: 15px; border-radius: 8px;"></div>
                    </div>
                `;
                                });

                                html += `
                <button onclick="submitQuiz()" class="generate-btn" style="background: linear-gradient(135deg, #10b981, #059669); margin-top: 20px;">
                    üì§ Submit Quiz
                </button>
            `;

                                container.innerHTML = html;
                            }

                            window.selectOption = (qIndex, optIndex, optValue) => {
                                currentQuizData[qIndex].userSelection = optValue;

                                const card = document.getElementById(`q-card-${qIndex}`);
                                const buttons = card.querySelectorAll('.option-btn');

                                buttons.forEach((btn, idx) => {
                                    if (idx === optIndex) {
                                        btn.classList.add('selected');
                                    } else {
                                        btn.classList.remove('selected');
                                    }
                                });
                            };

                            window.submitQuiz = () => {
                                // Check all answered
                                const unanswered = currentQuizData.filter(q => !q.userSelection);
                                if (unanswered.length > 0) {
                                    if (!confirm(`You have ${unanswered.length} unanswered questions. Submit anyway?`)) return;
                                }

                                let correctCount = 0;
                                const endTime = new Date();
                                const timeTaken = Math.round((endTime - quizStartTime) / 1000);

                                currentQuizData.forEach((q, i) => {
                                    const isCorrect = q.userSelection === q.answer;
                                    const feedbackEl = document.getElementById(`feedback-${i}`);

                                    q.status = isCorrect ? 'correct' : 'incorrect';
                                    if (isCorrect) correctCount++;

                                    feedbackEl.style.display = 'block';
                                    if (isCorrect) {
                                        feedbackEl.style.background = 'rgba(16, 185, 129, 0.1)';
                                        feedbackEl.style.border = '1px solid rgba(16, 185, 129, 0.3)';
                                        feedbackEl.innerHTML = `<div style="color: #10b981; font-weight: bold;">‚úÖ Correct!</div><div style="color: #94a3b8; margin-top: 5px;">${q.explanation || ''}</div>`;
                                    } else {
                                        feedbackEl.style.background = 'rgba(239, 68, 68, 0.1)';
                                        feedbackEl.style.border = '1px solid rgba(239, 68, 68, 0.3)';
                                        feedbackEl.innerHTML = `<div style="color: #ef4444; font-weight: bold;">‚ùå Incorrect</div><div style="color: #94a3b8; margin-top: 5px;">Correct: <strong>${q.answer}</strong><br>${q.explanation || ''}</div>`;
                                    }

                                    // Disable buttons
                                    const card = document.getElementById(`q-card-${i}`);
                                    card.querySelectorAll('button').forEach(b => b.disabled = true);
                                });

                                // Hide submit button
                                const submitBtn = document.querySelector('button[onclick="submitQuiz()"]');
                                if (submitBtn) submitBtn.style.display = 'none';

                                showResults(correctCount, timeTaken);
                            };

                            function showResults(correct, time) {
                                const total = currentQuizData.length;
                                const percentage = Math.round((correct / total) * 100);

                                document.getElementById('scoreDisplay').innerText = `${percentage}%`;
                                document.getElementById('correctCount').innerText = correct;
                                document.getElementById('timeDisplay').innerText = `${time}s`;
                                document.getElementById('totalQuestions').innerText = total;

                                const feedback = document.getElementById('quizFeedback');
                                if (percentage === 100) feedback.innerText = "üéâ Unstoppable! Perfect Score!";
                                else if (percentage >= 70) feedback.innerText = "üëç Great job! You know your stuff.";
                                else feedback.innerText = "üìö Keep learning! You'll master it soon.";

                                document.getElementById('quizResults').style.display = 'block';
                                document.getElementById('quizResults').scrollIntoView({ behavior: 'smooth' });

                                // Chart
                                const ctx = document.getElementById('performanceChart').getContext('2d');
                                if (quizChart) quizChart.destroy();

                                quizChart = new Chart(ctx, {
                                    type: 'doughnut',
                                    data: {
                                        labels: ['Correct', 'Incorrect'],
                                        datasets: [{
                                            data: [correct, total - correct],
                                            backgroundColor: ['#10b981', '#ef4444'],
                                            borderWidth: 0,
                                            cutout: '75%'
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        plugins: { legend: { display: false } }
                                    }
                                });
                            }
                        </script>



                        <div style="margin-top: 4rem; display: flex; justify-content: flex-end;">
                            <button class="btn" onclick="alert('Unit marked as complete! (Prototype action)')">Mark as
                                Complete</button>
                        </div>
        </div>
    </div>

    <%- include('partials/ai_video') %>
        <%- include('partials/footer') %>